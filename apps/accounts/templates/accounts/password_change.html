{% extends 'base.html' %}
{% load static %}

{% block title %}Ubah Password - Sistem Arsip Digital{% endblock %}

{% block page_title %}Ubah Password{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'accounts:profile' %}">Profil</a></li>
<li class="breadcrumb-item active">Ubah Password</li>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-6">
        <div class="card shadow">
            <div class="card-header">
                <h3 class="mb-0">Ubah Password</h3>
            </div>
            
            <form method="POST" action="{% url 'accounts:password_change' %}" id="passwordChangeForm">
                {% csrf_token %}
                
                <div class="card-body">
                    <!-- Old Password -->
                    <div class="form-group">
                        <label class="form-control-label" for="old_password">
                            Password Lama <span class="text-danger">*</span>
                        </label>
                        <div class="input-group input-group-merge">
                            <input type="password" class="form-control" id="old_password" name="old_password" placeholder="Masukkan password lama"required>
                            <div class="input-group-append">
                                <span class="input-group-text toggle-password" data-target="old_password" style="cursor: pointer;">
                                    <i class="fa-solid fa-eye"></i>
                                </span>
                            </div>
                        </div>
                        {% if form.old_password.errors %}
                        <small class="text-danger">{{ form.old_password.errors.0 }}</small>
                        {% endif %}
                    </div>
                    
                    <!-- New Password -->
                    <div class="form-group">
                        <label class="form-control-label" for="new_password1">
                            Password Baru <span class="text-danger">*</span>
                        </label>
                        <div class="input-group input-group-merge">
                            <input type="password" class="form-control" id="new_password1" name="new_password1" placeholder="Masukkan password baru"required>
                            <div class="input-group-append">
                                <span class="input-group-text toggle-password" data-target="new_password1" style="cursor: pointer;">
                                    <i class="fa-solid fa-eye"></i>
                                </span>
                            </div>
                        </div>
                        {% if form.new_password1.errors %}
                        <small class="text-danger">{{ form.new_password1.errors.0 }}</small>
                        {% endif %}
                        
                        <!-- Password Strength Indicator -->
                        <!-- <div class="progress mt-2" style="height: 5px;">
                            <div class="progress-bar" id="passwordStrength" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="passwordStrengthText">Kekuatan password: -</small> -->
                    </div>
                    
                    <!-- Confirm New Password -->
                    <div class="form-group">
                        <label class="form-control-label" for="new_password2">
                            Konfirmasi Password Baru <span class="text-danger">*</span>
                        </label>
                        <div class="input-group input-group-merge">
                            <input type="password" class="form-control" id="new_password2" name="new_password2" placeholder="Konfirmasi password baru"required>
                            <div class="input-group-append">
                                <span class="input-group-text toggle-password" data-target="new_password2" style="cursor: pointer;">
                                    <i class="fa-solid fa-eye"></i>
                                </span>
                            </div>
                        </div>
                        {% if form.new_password2.errors %}
                        <small class="text-danger">{{ form.new_password2.errors.0 }}</small>
                        {% endif %}
                        
                        <!-- Match Indicator -->
                        <!-- <small class="text-muted" id="passwordMatch"></small> -->
                    </div>
                </div>
                
                <div class="card-footer">
                    <div class="row">
                        <div class="col-6">
                            <a href="{% url 'accounts:profile' %}" class="btn btn-secondary btn-block">Batal</a>
                        </div>
                        <div class="col-6">
                            <button type="submit" class="btn btn-default btn-block">Ubah Password</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Toggle password visibility
    $('.toggle-password').on('click', function() {
        const target = $(this).data('target');
        const input = $('#' + target);
        const icon = $(this).find('i');
        
        if (input.attr('type') === 'password') {
            input.attr('type', 'text');
            icon.removeClass('fa-eye').addClass('fa-eye-slash');
        } else {
            input.attr('type', 'password');
            icon.removeClass('fa-eye-slash').addClass('fa-eye');
        }
    });
    
    // Password strength checker
    $('#new_password1').on('keyup', function() {
        const password = $(this).val();
        const strength = checkPasswordStrength(password);
        
        const $bar = $('#passwordStrength');
        const $text = $('#passwordStrengthText');
        
        $bar.removeClass('bg-danger bg-warning bg-success');
        
        if (strength.score === 0) {
            $bar.css('width', '0%');
            $text.text('Kekuatan password: -');
        } else if (strength.score <= 2) {
            $bar.addClass('bg-danger').css('width', '33%');
            $text.text('Kekuatan password: Lemah').addClass('text-danger');
        } else if (strength.score === 3) {
            $bar.addClass('bg-warning').css('width', '66%');
            $text.text('Kekuatan password: Sedang').removeClass('text-danger').addClass('text-warning');
        } else {
            $bar.addClass('bg-success').css('width', '100%');
            $text.text('Kekuatan password: Kuat').removeClass('text-warning').addClass('text-success');
        }
    });
    
    // Password match checker
    $('#new_password2').on('keyup', function() {
        const password1 = $('#new_password1').val();
        const password2 = $(this).val();
        const $match = $('#passwordMatch');
        
        if (password2.length > 0) {
            if (password1 === password2) {
                $match.html('<i class="fa-solid fa-check text-success"></i> Password cocok')
                      .removeClass('text-danger').addClass('text-success');
            } else {
                $match.html('<i class="fa-solid fa-times text-danger"></i> Password tidak cocok')
                      .removeClass('text-success').addClass('text-danger');
            }
        } else {
            $match.html('');
        }
    });
    
    function checkPasswordStrength(password) {
        let score = 0;
        
        if (!password) return { score: 0 };
        
        // Length
        if (password.length >= 8) score++;
        if (password.length >= 12) score++;
        
        // Lowercase and uppercase
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score++;
        
        // Numbers
        if (/\d/.test(password)) score++;
        
        // Special characters
        if (/[^A-Za-z0-9]/.test(password)) score++;
        
        return { score: Math.min(score, 4) };
    }
    
    // Form validation
    $('#passwordChangeForm').on('submit', function(e) {
        const password1 = $('#new_password1').val();
        const password2 = $('#new_password2').val();
        
        if (password1 !== password2) {
            e.preventDefault();
            alert('Password baru dan konfirmasi password tidak cocok!');
            return false;
        }
        
        // Show loading
        const submitBtn = $(this).find('button[type="submit"]');
        submitBtn.prop('disabled', true);
        submitBtn.html('<i class="fa-solid fa-spinner fa-spin"></i> Memproses...');
    });
});
</script>
{% endblock %}
{% load static %}
{% load date_filters %}
{% load custom_tags %}

<!-- Right Detail Panel - Google Drive Style -->
<div class="card shadow-lg animate__animated animate__fadeInRight" id="documentDetailPanel">
    <div class="card-header bg-default">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0 text-white">Detail Dokumen</h5>
            </div>
            <div class="col-auto">
                <button type="button" class="close text-white" onclick="closeDetailPanel()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Tabs -->
    <div class="card-header bg-white border-0 pb-0">
        <ul class="nav nav-tabs nav-fill border-bottom-0" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="detail-tab" data-toggle="tab" href="#detailContent" role="tab">
                    <i class="fa-solid fa-circle-info"></i> Detail
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="activity-tab" data-toggle="tab" href="#activityContent" role="tab">
                    <i class="fa-solid fa-clock-rotate-left"></i> Aktivitas
                </a>
            </li>
        </ul>
    </div>
    
    <div class="card-body p-0" style="max-height: calc(100vh - 250px); overflow-y: auto;">
        <div class="tab-content">
            <!-- Detail Tab -->
            <div class="tab-pane fade show active" id="detailContent" role="tabpanel">
                <div class="p-4" id="detailContentBody">
                    <!-- Content loaded via AJAX -->
                    <div class="text-center py-5">
                        <div class="spinner-border text-default" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="text-muted mt-3">Memuat detail dokumen...</p>
                    </div>
                </div>
            </div>
            
            <!-- Activity Tab -->
            <div class="tab-pane fade" id="activityContent" role="tabpanel">
                <div class="p-3" id="activityContentBody">
                    <!-- Content loaded via AJAX -->
                    <div class="text-center py-5">
                        <div class="spinner-border text-default" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="text-muted mt-3">Memuat aktivitas...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="card-footer bg-white border-top">
        <div class="row">
            <div class="col-6">
                <button type="button" class="btn btn-block btn-info btn-sm" id="btnPreview">
                    <i class="fa-solid fa-eye"></i> Preview
                </button>
            </div>
            <div class="col-6">
                <button type="button" class="btn btn-block btn-success btn-sm" id="btnDownload">
                    <i class="fa-solid fa-download"></i> Download
                </button>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-6">
                <button type="button" class="btn btn-block btn-warning btn-sm" id="btnEdit">
                    <i class="fa-solid fa-pen"></i> Edit
                </button>
            </div>
            <div class="col-6">
                <button type="button" class="btn btn-block btn-danger btn-sm" id="btnDelete">
                    <i class="fa-solid fa-trash"></i> Hapus
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentDocumentId = null;

// Show detail panel
function showDetailPanel(documentId) {
    currentDocumentId = documentId;
    
    // Adjust layout
    $('#mainContent').removeClass('col-12').addClass('col-xl-8 col-lg-7');
    $('#detailPanel').show().find('#documentDetailPanel').addClass('animate__animated animate__fadeInRight');
    
    // Load document details
    loadDocumentDetails(documentId);
    
    // Setup action buttons
    $('#btnPreview').off('click').on('click', function() {
        window.open(`/archive/documents/${documentId}/preview/`, '_blank');
    });
    
    $('#btnDownload').off('click').on('click', function() {
        window.location.href = `/archive/documents/${documentId}/download/`;
    });
    
    $('#btnEdit').off('click').on('click', function() {
        showEditModal(documentId);
    });
    
    $('#btnDelete').off('click').on('click', function() {
        if (confirm('Apakah Anda yakin ingin menghapus dokumen ini?')) {
            deleteDocument(documentId);
        }
    });
}

// Close detail panel
function closeDetailPanel() {
    $('#mainContent').removeClass('col-xl-8 col-lg-7').addClass('col-12');
    $('#detailPanel').hide();
    currentDocumentId = null;
}

// Load document details via AJAX
function loadDocumentDetails(documentId) {
    $.ajax({
        url: `/api/documents/${documentId}/`,
        method: 'GET',
        success: function(data) {
            renderDocumentDetails(data);
        },
        error: function(xhr) {
            $('#detailContentBody').html(
                '<div class="text-center py-5">' +
                '<i class="fa-solid fa-triangle-exclamation fa-3x text-danger mb-3"></i>' +
                '<p class="text-danger">Gagal memuat detail dokumen</p>' +
                '</div>'
            );
        }
    });
    
    // Load activities
    $.ajax({
        url: `/api/documents/${documentId}/activities/`,
        method: 'GET',
        success: function(data) {
            renderActivities(data);
        },
        error: function(xhr) {
            $('#activityContentBody').html(
                '<div class="text-center py-5">' +
                '<i class="fa-solid fa-triangle-exclamation fa-3x text-danger mb-3"></i>' +
                '<p class="text-danger">Gagal memuat aktivitas</p>' +
                '</div>'
            );
        }
    });
}

// Render document details
function renderDocumentDetails(doc) {
    let categoryBadge = doc.category_name;
    let badgeClass = doc.spd_info ? 'badge-warning' : 'badge-success';
    
    let html = `
        <!-- PDF Preview -->
        <div class="mb-4">
            <div class="embed-responsive embed-responsive-4by3 rounded shadow-sm">
                <iframe class="embed-responsive-item" 
                        src="${doc.file_url}#toolbar=0" 
                        type="application/pdf"
                        style="border: 1px solid #dee2e6;">
                </iframe>
            </div>
        </div>
        
        <!-- Document Info -->
        <div class="mb-4">
            <h6 class="text-uppercase text-muted mb-3">Informasi Dokumen</h6>
            
            <div class="row mb-2">
                <div class="col-5 text-muted">
                    <i class="fa-solid fa-file-pdf text-danger"></i> Nama File
                </div>
                <div class="col-7">
                    <strong>${doc.file_url.split('/').pop()}</strong>
                </div>
            </div>
            
            <div class="row mb-2">
                <div class="col-5 text-muted">
                    <i class="fa-solid fa-folder"></i> Kategori
                </div>
                <div class="col-7">
                    <span class="badge ${badgeClass}">${categoryBadge}</span>
                </div>
            </div>
            
            <div class="row mb-2">
                <div class="col-5 text-muted">
                    <i class="fa-solid fa-calendar"></i> Tanggal Dokumen
                </div>
                <div class="col-7">
                    ${doc.document_date_formatted}
                </div>
            </div>
            
            <div class="row mb-2">
                <div class="col-5 text-muted">
                    <i class="fa-solid fa-weight-scale"></i> Ukuran File
                </div>
                <div class="col-7">
                    ${doc.file_size_display}
                </div>
            </div>
            
            <div class="row mb-2">
                <div class="col-5 text-muted">
                    <i class="fa-solid fa-user"></i> Diupload Oleh
                </div>
                <div class="col-7">
                    ${doc.created_by_name}
                </div>
            </div>
            
            <div class="row mb-2">
                <div class="col-5 text-muted">
                    <i class="fa-solid fa-clock"></i> Tanggal Upload
                </div>
                <div class="col-7">
                    ${doc.created_at_formatted}
                </div>
            </div>
        </div>
    `;
    
    // Add SPD specific info
    if (doc.spd_info) {
        html += `
            <div class="mb-4">
                <h6 class="text-uppercase text-muted mb-3">Informasi SPD</h6>
                
                <div class="row mb-2">
                    <div class="col-5 text-muted">
                        <i class="fa-solid fa-user-tie"></i> Pegawai
                    </div>
                    <div class="col-7">
                        <strong>${doc.spd_info.employee_name}</strong><br>
                        <small class="text-muted">NIP: ${doc.spd_info.employee_nip}</small>
                    </div>
                </div>
                
                <div class="row mb-2">
                    <div class="col-5 text-muted">
                        <i class="fa-solid fa-location-dot"></i> Tujuan
                    </div>
                    <div class="col-7">
                        ${doc.spd_info.destination_display}
                    </div>
                </div>
                
                <div class="row mb-2">
                    <div class="col-5 text-muted">
                        <i class="fa-solid fa-calendar-days"></i> Periode
                    </div>
                    <div class="col-7">
                        ${doc.spd_info.start_date} s/d ${doc.spd_info.end_date}<br>
                        <small class="text-muted">(${doc.spd_info.duration_days} hari)</small>
                    </div>
                </div>
            </div>
        `;
    }
    
    $('#detailContentBody').html(html);
}

// Render activities timeline
function renderActivities(activities) {
    if (activities.length === 0) {
        $('#activityContentBody').html(
            '<div class="text-center py-5">' +
            '<i class="fa-solid fa-inbox fa-3x text-muted mb-3"></i>' +
            '<p class="text-muted">Belum ada aktivitas</p>' +
            '</div>'
        );
        return;
    }
    
    let html = '<div class="timeline timeline-one-side" data-timeline-axis-style="dashed">';
    
    activities.forEach(function(activity, index) {
        let iconClass = getActivityIcon(activity.action_type);
        let colorClass = getActivityColor(activity.action_type);
        
        html += `
            <div class="timeline-block">
                <span class="timeline-step badge-${colorClass}">
                    <i class="fa-solid ${iconClass}"></i>
                </span>
                <div class="timeline-content">
                    <small class="text-muted font-weight-bold">${activity.time_ago}</small>
                    <h5 class="mt-1 mb-0">${activity.action_display}</h5>
                    ${activity.description ? `<p class="text-sm mt-1 mb-0">${activity.description}</p>` : ''}
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fa-solid fa-user"></i> ${activity.user_name}
                        </small>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    $('#activityContentBody').html(html);
}

// Helper functions
function getActivityIcon(actionType) {
    const icons = {
        'create': 'fa-plus',
        'delete': 'fa-trash',
        'download': 'fa-download',
        'view': 'fa-eye',
        'update': 'fa-pen'
    };
    return icons[actionType] || 'fa-circle-info';
}

function getActivityColor(actionType) {
    const colors = {
        'create': 'success',
        'delete': 'danger',
        'download': 'warning',
        'view': 'info',
        'update': 'info'
    };
    return colors[actionType] || 'default';
}

// Delete document
function deleteDocument(documentId) {
    $.ajax({
        url: `/archive/documents/${documentId}/delete/`,
        method: 'POST',
        success: function(response) {
            closeDetailPanel();
            location.reload();
        },
        error: function(xhr) {
            alert('Gagal menghapus dokumen');
        }
    });
}
</script>
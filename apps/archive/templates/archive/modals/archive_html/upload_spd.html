{% load static %}
<!-- Upload SPD Modal -->
<div class="modal fade" id="uploadSPDModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-md" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Dokumen SPD</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <form id="uploadSPDForm" method="post" action="{% url 'archive:spd_upload' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <!-- File Upload -->
                    <div class="form-group">
                        <label class="form-control-label" for="spd_file">File PDF <span class="text-danger">*</span></label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="spd_file" name="file" accept="application/pdf"required>
                            <label class="custom-file-label" for="spd_file">Pilih file...</label>
                        </div>
                    </div>
                    <div class="row"> 
                        <div class="col-md-6">
                            <!-- Employee - Select2 (belum berfungsi) -->
                            <div class="form-group">
                                <label class="form-control-label" for="spd_employee">Pegawai <span class="text-danger">*</span></label>
                                <select class="form-control select2" 
                                        id="spd_employee" 
                                        name="employee" 
                                        style="width: 100%;"
                                        required>
                                    <option value=""> Pilih Pegawai </option>
                                    {% for employee in employees %}
                                    <option value="{{ employee.id }}">
                                        {{ employee.name }} ({{ employee.nip }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <!-- Destination - Select2 (belum berfungsi) -->
                            <div class="form-group">
                                <label class="form-control-label" for="spd_destination">
                                    Tujuan <span class="text-danger">*</span>
                                </label>
                                <select class="form-control" 
                                        id="spd_destination" 
                                        name="destination"
                                        onchange="toggleDestinationOther(this)"
                                        required>
                                    <option value=""> Pilih Tujuan </option>
                                    <optgroup label="Dalam Provinsi Kalimantan Timur">
                                        <option value="balikpapan">Balikpapan</option>
                                        <option value="samarinda">Samarinda</option>
                                        <option value="bontang">Bontang</option>
                                        <option value="kutai_kartanegara">Kutai Kartanegara</option>
                                        <option value="paser">Paser</option>
                                        <option value="berau">Berau</option>
                                        <option value="kutai_barat">Kutai Barat</option>
                                        <option value="kutai_timur">Kutai Timur</option>
                                        <option value="penajam_paser_utara">Penajam Paser Utara</option>
                                        <option value="mahakam_ulu">Mahakam Ulu</option>
                                    </optgroup>
                                    <optgroup label="Luar Provinsi">
                                        <option value="jakarta">Jakarta</option>
                                        <option value="surabaya">Surabaya</option>
                                        <option value="makassar">Makassar</option>
                                        <option value="banjarmasin">Banjarmasin</option>
                                        <option value="yogyakarta">Yogyakarta</option>
                                        <option value="bandung">Bandung</option>
                                        <option value="semarang">Semarang</option>
                                        <option value="denpasar">Denpasar</option>
                                    </optgroup>
                                    <option value="other">Lainnya...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <!-- Destination Other (hidden by default) -->
                    <div class="form-group" id="destination_other_group" style="display: none;">
                        <label class="form-control-label" for="spd_destination_other">Tujuan Lainnya <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="spd_destination_other" name="destination_other" placeholder="Masukkan nama kota/kabupaten tujuan">
                    </div>
                    <div class="row input-daterange datepicker align-items-center"> 
                        <div class="col-md-6">
                            <!-- Start Date - Datepicker (belum berfungsi) -->
                            <div class="form-group">
                                <label class="form-control-label" for="spd_start_date">Tanggal Mulai <span class="text-danger">*</span></label>
                                <input type="text" class="form-control datepicker" id="spd_start_date" name="start_date" placeholder="dd/mm/yyyy"required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <!-- End Date - Datepicker (belum berfungsi) -->
                            <div class="form-group">
                                <label class="form-control-label" for="spd_end_date">Tanggal Selesai <span class="text-danger">*</span></label>
                                <input type="text" class="form-control datepicker" id="spd_end_date" name="end_date" placeholder="dd/mm/yyyy"required>
                            </div>
                        </div>
                    </div>

                    <!-- Document Date -->
                    <!-- <div class="form-group">
                        <label class="form-control-label" for="spd_document_date">
                            Tanggal SPD <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text">
                                    <i class="fa-solid fa-calendar"></i>
                                </span>
                            </div>
                            <input type="text" class="form-control datepicker" id="spd_document_date" name="document_date" placeholder="dd/mm/yyyy"required>
                        </div>
                    </div> -->

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-default">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
$('#uploadSPDForm').on('submit', function(e) {
    e.preventDefault();
    const form = $(this)[0];
    const data = new FormData(form);
    const submitBtn = $(this).find('button[type="submit"]');

    submitBtn.prop('disabled', true).html('<i class="fa-solid fa-spinner fa-spin mr-1"></i> Mengunggah...');

    $.ajax({
        type: 'POST',
        url: $(this).attr('action'),
        data: data,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                $('#uploadSPDModal').modal('hide');
                showNotification('success', response.message);
                setTimeout(() => location.reload(), 1200);
            } else {
                showNotification('danger', 'Gagal mengunggah SPD.');
                console.error(response.errors);
            }
        },
        error: function() {
            showNotification('danger', 'Terjadi kesalahan server.');
        },
        complete: function() {
            submitBtn.prop('disabled', false).html('<i class="fa-solid fa-upload mr-1"></i> Upload');
        }
    });
});
</script>
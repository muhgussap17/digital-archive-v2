{% load static %}
<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Filter Dokumen</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="get" action="{% url 'archive:document_list' %}" id="filterForm">
                <div class="modal-body">
                    <!-- Search Input -->
                    <div class="form-group">
                        <label class="form-control-label">Pencarian</label>
                        <input type="text" 
                               name="search" 
                               class="form-control" 
                               placeholder="Cari nama pegawai, tujuan, atau kategori..."
                               value="{{ request.GET.search }}">
                    </div>
                    
                    <!-- Category Filter - Select2 (belum berfungsi) -->
                    <div class="form-group">
                        <label class="form-control-label">Kategori</label>
                        <select name="category" class="form-control">
                            <option value="">Semua Kategori</option>
                            {% for category in categories %}
                                <option value="{{ category.id }}" {% if request.GET.category == category.id|stringformat:"s" %}selected{% endif %}>
                                    {{ category.name }}
                                </option>
                                {% if category.children.all %}
                                    {% for child in category.children.all %}
                                    <option value="{{ child.id }}" {% if request.GET.category == child.id|stringformat:"s" %}selected{% endif %}>
                                        {{ child.name }}
                                    </option>
                                    {% endfor %}
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Date Range Filter - Datepicker (berfungsi) -->
                    <div class="row input-daterange datepicker align-items-center">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-control-label">Date From</label>
                                <input type="text" name="date_from" class="form-control datepicker" placeholder="dd/mm/yyyy"autocomplete="off"value="{{ request.GET.date_from }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-control-label">Date To</label>
                                <input type="text" name="date_to" class="form-control datepicker" placeholder="dd/mm/yyyy"autocomplete="off"value="{{ request.GET.date_to }}">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Employee Filter - Select2 (belum berfungsi) -->
                    <div class="form-group">
                        <label class="form-control-label">Pegawai (Khusus SPD)</label>
                        <select name="employee" class="form-control select2">
                            <option value="">Semua Pegawai</option>
                            {% for employee in employees %}
                            <option value="{{ employee.id }}" {% if request.GET.employee == employee.id|stringformat:"s" %}selected{% endif %}>
                                {{ employee.name }} ({{ employee.nip }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Active Filters Display -->
                    <div id="activeFilters" class="mt-3">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="modal-footer">
                    <!-- <a href="{% url 'archive:document_list' %}" class="btn btn-secondary">Reset</a> -->
                    <button type="button" class="btn btn-secondary" id="btnResetFilter">Reset</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Tutup</button>
                    <button type="submit" class="btn btn-default">Terapkan Filter</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Initialize Select2 for employee filter
    $('#filter_employee').select2({
        dropdownParent: $('#filterModal'),
        placeholder: 'Semua Pegawai',
        allowClear: true,
    });
    
    // Re-initialize datepicker after modal shown
    $('#filterModal').on('shown.bs.modal', function() {
        $('.datepicker').datepicker({
            format: 'dd/mm/yyyy',
            language: 'id',
            autoclose: true,
            todayHighlight: true,
            orientation: 'bottom auto'
        });
        
        updateActiveFilters();
    });
    
    // Reset filter
    $('#btnResetFilter').on('click', function() {
        $('#filterForm')[0].reset();
        $('#filter_employee').val(null).trigger('change');
        $('#activeFilters').empty();
        
        // Submit form to clear filters
        window.location.href = '{% url "archive:document_list" %}';
    });
    
    // Update active filters display
    function updateActiveFilters() {
        const filters = [];
        
        if ($('#filter_search').val()) {
            filters.push({
                label: 'Pencarian',
                value: $('#filter_search').val()
            });
        }
        
        if ($('#filter_category').val()) {
            filters.push({
                label: 'Kategori',
                value: $('#filter_category option:selected').text()
            });
        }
        
        if ($('#filter_date_from').val()) {
            filters.push({
                label: 'Dari',
                value: $('#filter_date_from').val()
            });
        }
        
        if ($('#filter_date_to').val()) {
            filters.push({
                label: 'Sampai',
                value: $('#filter_date_to').val()
            });
        }
        
        if ($('#filter_employee').val()) {
            filters.push({
                label: 'Pegawai',
                value: $('#filter_employee option:selected').text()
            });
        }
        
        if (filters.length > 0) {
            let html = '<div class="alert alert-info alert-sm mb-0">' +
                       '<strong><i class="fa-solid fa-circle-info"></i> Filter Aktif:</strong><br>';
            
            filters.forEach(function(filter) {
                html += '<span class="badge badge-info mr-1">' + filter.label + ': ' + filter.value + '</span>';
            });
            
            html += '</div>';
            $('#activeFilters').html(html);
        } else {
            $('#activeFilters').empty();
        }
    }
    
    // Update active filters on input change
    $('#filterForm input, #filterForm select').on('change', updateActiveFilters);
});
</script>
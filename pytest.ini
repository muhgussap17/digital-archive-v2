# pytest.ini
# Konfigurasi Pytest untuk Sistem Arsip Digital

[pytest]
# Django settings module
DJANGO_SETTINGS_MODULE = config.settings

# Python files matching pattern akan di-run sebagai tests
python_files = test_*.py *_test.py tests.py

# Python classes matching pattern akan di-run sebagai test classes
python_classes = Test* *Tests

# Python functions matching pattern akan di-run sebagai test functions
python_functions = test_*

# Test discovery paths
testpaths = apps/archive/tests

# Additional command line options
addopts = 
    # Verbose output
    -v
    # Show local variables in tracebacks
    --tb=short
    # Show summary of all test outcomes
    -ra
    # Strict markers - fail jika unknown marker digunakan
    --strict-markers
    # Coverage options
    --cov=apps.archive
    --cov-report=html
    --cov-report=term-missing
    --cov-fail-under=80
    # Parallel execution (gunakan jika tests banyak)
    # -n auto
    # Rerun failed tests first
    --failed-first
    # Show warnings
    -W default

# Markers untuk categorize tests
markers =
    unit: Unit tests (fast, isolated)
    integration: Integration tests (slower, multiple components)
    slow: Slow tests (bisa di-skip untuk quick checks)
    service: Service layer tests
    utils: Utility function tests
    forms: Form tests
    views: View tests
    models: Model tests
    ajax: AJAX functionality tests
    file_ops: File operation tests

# Django configuration
django_find_project = true

# Filterwarnings
filterwarnings =
    # Ignore specific Django warnings
    ignore::DeprecationWarning:django.*
    # Error on other warnings (make tests fail)
    error::UserWarning

# Console output format
console_output_style = progress

# Minimum Python version
minversion = 7.0

# Test execution order
# Gunakan --randomly untuk randomize order (butuh pytest-randomly plugin)
# --randomly-seed=value untuk reproducible random order

# Timeout untuk tests (butuh pytest-timeout plugin)
# timeout = 300  # 5 minutes default timeout

# ==================== COVERAGE CONFIGURATION ====================
# Coverage.py akan read dari [tool:coverage] section ini

[coverage:run]
# Source paths untuk coverage analysis
source = apps/archive

# Omit specific files dari coverage
omit =
    */migrations/*
    */tests/*
    */__init__.py
    */admin.py
    */apps.py
    */conftest.py
    */factories.py

# Branch coverage (lebih strict)
branch = True

# Parallel mode untuk multi-process testing
# parallel = True

[coverage:report]
# Minimum coverage percentage
fail_under = 80

# Precision untuk percentages
precision = 2

# Show missing lines
show_missing = True

# Skip covered files
skip_covered = False

# Skip empty files
skip_empty = True

# Ignore errors
ignore_errors = True

# Exclude lines dari coverage
exclude_lines =
    # Exclude pragma comments
    pragma: no cover
    # Exclude defensive programming
    raise AssertionError
    raise NotImplementedError
    # Exclude debugging code
    if __name__ == .__main__.:
    # Exclude abstract methods
    @abstractmethod
    # Exclude type checking blocks
    if TYPE_CHECKING:
    # Exclude ellipsis
    \.\.\.

[coverage:html]
# HTML report directory
directory = htmlcov

# Title untuk HTML report
title = Sistem Arsip Digital - Coverage Report

[coverage:paths]
# Path mapping untuk coverage combination
source =
    apps/archive/
    */site-packages/apps/archive/
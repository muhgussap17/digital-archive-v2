{% load static %}
{% load custom_tags %}
{% load date_filters %}

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>{% block title %}Sistem Arsip Digital{% endblock %}</title>
    
    <!-- Favicon -->
    <link href="{% static 'argon/img/brand/favicon.png' %}" rel="icon" type="image/png">
    
    <!-- Icons - FontAwesome 7 -->
    <link href="{% static 'vendor/fontawesome/css/fontawesome.min.css' %}" rel="stylesheet">
    <link href="{% static 'vendor/fontawesome/css/solid.min.css' %}" rel="stylesheet">
    <link href="{% static 'vendor/fontawesome/css/regular.min.css' %}" rel="stylesheet">
    
    <!-- Select2 -->
    <link href="{% static 'vendor/select2/dist/css/select2.min.css' %}" rel="stylesheet">
    
    <!-- Animate.css -->
    <link href="{% static 'vendor/animate.css/animate.min.css' %}" rel="stylesheet">
    
    {% block extra_css %}{% endblock %}
    
    <!-- Argon CSS -->
    <link href="{% static 'css/argon.min.css' %}" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="{% static 'css/custom.css' %}" rel="stylesheet">
    <link href="{% static 'css/select2-argon-fix.css' %}" rel="stylesheet">
</head>

<body>
    <!-- Sidebar -->
    {% include 'partials/sidebar.html' %}

    <!-- Main content -->
    <div class="main-content" id="panel">
        
        <!-- Topnav -->
        {% include 'partials/navbar.html' %}
        
        <!-- Panel -->
        {% include 'partials/right_panel.html' %}

        <!-- Header -->
        {% block header %}
        <div class="header bg-default pb-6">
            <div class="container-fluid">
                <div class="header-body">
                    <div class="row align-items-center py-4">
                        <div class="col-lg-6 col-7">
                            <h6 class="h2 text-white d-inline-block mb-0">{% block page_title %}Dashboard{% endblock %}</h6>
                            <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
                                <ol class="breadcrumb breadcrumb-links breadcrumb-dark">
                                    <li class="breadcrumb-item"><a href="{% url 'archive:dashboard' %}"><i class="fa-solid fa-house"></i></a></li>
                                    {% block breadcrumb %}{% endblock %}
                                </ol>
                            </nav>
                        </div>
                        <div class="col-lg-6 col-5 text-right">
                            {% block header_actions %}{% endblock %}
                        </div>
                    </div>
                    {% block header_stats %}{% endblock %}
                </div>
            </div>
        </div>
        {% endblock %}
        
        <!-- Page content -->
        <div class="container-fluid mt--6">
            
            <!-- Messages -->
            <div id="django-messages-container" style="display: none;">
                {% if messages %}
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show animate__animated animate__fadeInDown" role="alert" data-type="{{ message.tags }}" data-message="{{ message }}">
                        <span class="alert-icon"><i class="fa-solid fa-circle-info"></i></span>
                        <span class="alert-text">{{ message }}</span>
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
            
            <div class="page-content">
                <!-- Main Content -->
                {% block content %}{% endblock %}
            </div>
            
            <!-- Footer -->
            {% include 'partials/footer.html' %}
        </div>
    </div>
    
    <!-- Modal Includes (Global) -->
    {% include 'archive/modals/document_modal.html' %}
    {% include 'archive/modals/spd_modal.html' %}

    <!-- Employee Modals -->
    {% include 'archive/modals/employee_modal.html' %}

    <!-- User Modals -->
    {% include 'accounts/modals/user_modal.html' %}
    {% include 'accounts/modals/reset_password_modal.html' %}
    
    <!-- Delete Confirm -->
    {% include 'archive/modals/delete_confirm_modal.html' %}
    
    {% block filter_modal %}{% endblock %}
            
    <!-- Core JS -->
    <script src="{% static 'vendor/jquery/dist/jquery.min.js' %}"></script>
    <script src="{% static 'vendor/bootstrap/dist/js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'vendor/js-cookie/js.cookie.js' %}"></script>
    <script src="{% static 'vendor/jquery.scrollbar/jquery.scrollbar.min.js' %}"></script>
    <script src="{% static 'vendor/jquery-scroll-lock/dist/jquery-scrollLock.min.js' %}"></script>

    <!-- Argon JS -->
    <script src="{% static 'js/argon.js' %}"></script>
    
    <!-- Chart.js -->
    <script src="{% static 'vendor/chart.js/dist/Chart.min.js' %}"></script>
    <script src="{% static 'vendor/chart.js/dist/Chart.extension.js' %}"></script>
    
    <!-- Select2 -->
    <script src="{% static 'vendor/select2/dist/js/select2.min.js' %}"></script>
    
    <!-- Bootstrap Datepicker -->
    <script src="{% static 'vendor/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js' %}"></script>
    <script src="{% static 'vendor/bootstrap-datepicker/dist/locales/bootstrap-datepicker.id.min.js' %}"></script>
    
    <!-- Bootstrap Notify -->
    <script src="{% static 'vendor/bootstrap-notify/bootstrap-notify.min.js' %}"></script>
    
    <!-- Custom JS -->
    <script src="{% static 'js/custom.js' %}"></script>
    
    <!-- Handler JS -->
    <script src="{% static 'js/modal_handler.js' %}"></script>
    <script src="{% static 'js/panel_handler.js' %}"></script>

    <script>
        // CSRF token untuk AJAX - IMPROVED
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Get CSRF token
        const csrftoken = getCookie('csrftoken');
        console.log('CSRF Token loaded:', csrftoken ? 'OK' : 'FAILED');
        
        // Setup AJAX dengan CSRF token
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                    // Ambil token dari cookie atau input hidden
                    const token = csrftoken || $('[name=csrfmiddlewaretoken]').val();
                    if (token) {
                        xhr.setRequestHeader("X-CSRFToken", token);
                    }
                }
            }
        });
        
        // Auto-hide alerts
        setTimeout(function() {
            $('.alert').fadeOut('slow');
        }, 5000);
        
        // Menampilkan notifikasi menggunakan Bootstrap Notify
        function showNotification(type, message, title) {
            $.notify({
                icon: 'fa-solid fa-bell',
                title: title || '',
                message: message
            }, {
                type: type, // success, info, warning, danger
                placement: {
                    from: 'top',
                    align: 'right'
                },
                delay: 4000,
                animate: {
                    enter: 'animate__animated animate__fadeInDown',
                    exit: 'animate__animated animate__fadeOutUp'
                }
            });
        }
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>